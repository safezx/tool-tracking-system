<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–±–æ—Ç–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .tool-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #4CAF50;
        }
        
        .tool-info h2 {
            margin-top: 0;
            color: #333;
        }
        
        .tool-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .status-available {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-taken {
            background: #ffebee;
            color: #c62828;
        }
        
        .tool-details {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-take {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-return {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-take:hover {
            background-color: #45a049;
        }
        
        .btn-return:hover {
            background-color: #1976D2;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .result-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .active-request-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        
        .active-request-info h3 {
            margin-top: 0;
            color: #1565c0;
        }
        
        .time-info {
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: 3px;
            margin: 5px 0;
        }
        
        .qr-code-display {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 2px dashed #4CAF50;
        }
        
        .qr-code {
            font-family: monospace;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="tool-info">
        <h2>{{ tool.name }}</h2>
        <div class="qr-code-display">
            <div>QR-–∫–æ–¥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:</div>
            <div class="qr-code">{{ tool.qr_code_identifier }}</div>
        </div>
        
        {% if tool.description %}
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ tool.description }}</p>
        {% endif %}
        
        {% if tool.location %}
        <p><strong>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è:</strong> {{ tool.location }}{% if tool.storage_place %} ({{ tool.storage_place }}){% endif %}</p>
        {% endif %}
        
        {% if tool.model or tool.manufacturer %}
        <p>
            {% if tool.manufacturer %}<strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> {{ tool.manufacturer }}{% endif %}
            {% if tool.model %}<strong>–ú–æ–¥–µ–ª—å:</strong> {{ tool.model }}{% endif %}
        </p>
        {% endif %}
        
        <div class="tool-status {% if tool.is_available %}status-available{% else %}status-taken{% endif %}">
            {% if tool.is_available %}
            ‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–∑—è—Ç–∏—è
            {% else %}
            ‚ùå –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–¥–∞–Ω
            {% endif %}
        </div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –≤—ã–¥–∞—á–µ, –µ—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–¥–∞–Ω -->
    {% if not tool.is_available and active_request %}
    <div class="active-request-info">
        <h3>üìã –ê–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞</h3>
        <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ active_request.requester.full_name() }}</p>
        <p><strong>–ü–æ–ª—É—á–µ–Ω:</strong> <span class="time-info">{{ format_moscow_time(active_request.approval_time, '%d.%m.%Y %H:%M') }}</span></p>
        <p><strong>–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:</strong> <span class="time-info">{{ format_moscow_time(active_request.expected_return_time, '%d.%m.%Y %H:%M') }}</span></p>
        {% if active_request.purpose %}
        <p><strong>–¶–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</strong> {{ active_request.purpose }}</p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–∑—è—Ç–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ -->
    <div id="takeForm" {% if not tool.is_available %}style="display: none;"{% endif %}>
        <h2>üì¶ –í–∑—è—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>
        <form id="takeToolForm">
            <div class="form-group">
                <label for="first_name">–ò–º—è *</label>
                <input type="text" id="first_name" required placeholder="–í–∞—à–µ –∏–º—è">
            </div>
            
            <div class="form-group">
                <label for="last_name">–§–∞–º–∏–ª–∏—è *</label>
                <input type="text" id="last_name" required placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è">
            </div>
            
            <div class="form-group">
                <label for="employee_id">–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                <input type="text" id="employee_id" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ">
            </div>
            
            <div class="form-group">
                <label for="purpose">–î–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç?</label>
                <input type="text" id="purpose" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è">
            </div>
            
            <button type="button" class="btn btn-take" onclick="takeTool()">–í–∑—è—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</button>
        </form>
    </div>
    
    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ -->
    <div id="returnForm" {% if tool.is_available %}style="display: none;"{% endif %}>
        <h2>‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>
        <form id="returnToolForm">
            <div class="form-group">
                <label for="return_first_name">–ò–º—è *</label>
                <input type="text" id="return_first_name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–∞–∫ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏">
            </div>
            
            <div class="form-group">
                <label for="return_last_name">–§–∞–º–∏–ª–∏—è *</label>
                <input type="text" id="return_last_name" required placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∫–∞–∫ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏">
            </div>
            
            <div class="form-group">
                <label for="return_employee_id">–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                <input type="text" id="return_employee_id" placeholder="–ï—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–ª–∏ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏">
            </div>
            
            <div class="form-group">
                <label for="condition_after">–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</label>
                <input type="text" id="condition_after" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∏—Å–ø—Ä–∞–≤–µ–Ω, –µ—Å—Ç—å —Ü–∞—Ä–∞–ø–∏–Ω—ã, —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞">
            </div>
            
            <div class="form-group">
                <label for="return_notes">–ó–∞–º–µ—Ç–∫–∏</label>
                <input type="text" id="return_notes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">
            </div>
            
            <button type="button" class="btn btn-return" onclick="returnTool()">–í–µ—Ä–Ω—É—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</button>
        </form>
    </div>
    
    <div id="result"></div>
    
    <div style="margin-top: 30px; text-align: center;">
        <a href="/" style="color: #4CAF50; text-decoration: none;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
    
    <script>
        let currentToolId = '{{ tool.id }}';
        let isToolAvailable = '{{ tool.is_available }}' === 'True';

        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∑—è—Ç–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        async function takeTool() {
            const firstName = document.getElementById('first_name').value.trim();
            const lastName = document.getElementById('last_name').value.trim();
            const employeeId = document.getElementById('employee_id').value.trim();
            const purpose = document.getElementById('purpose').value.trim();
            const resultDiv = document.getElementById('result');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!firstName || !lastName) {
                showResult('error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ò–º—è –∏ –§–∞–º–∏–ª–∏—è');
                return;
            }
            
            showResult('info', '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const checkResponse = await fetch('/api/check-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        employee_id: employeeId
                    })
                });
                
                const checkData = await checkResponse.json();
                
                if (!checkData.success) {
                    showResult('error', checkData.message);
                    return;
                }
                
                // –°–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É
                const createResponse = await fetch('/api/create-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: checkData.user.id,
                        tool_id: currentToolId,
                        purpose: purpose
                    })
                });
                
                const createData = await createResponse.json();
                
                if (createData.success) {
                    showResult('success', 
                        '‚úÖ ' + createData.message + 
                        '<br>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: ' + createData.request_id +
                        '<br>–í—Ä–µ–º—è: ' + createData.timestamp);
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('takeToolForm').reset();
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Ñ–æ—Ä–º—É –≤–æ–∑–≤—Ä–∞—Ç–∞
                    document.getElementById('takeForm').style.display = 'none';
                    document.getElementById('returnForm').style.display = 'block';
                    isToolAvailable = false;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    updateToolStatus(false);
                    
                } else {
                    showResult('error', '‚ùå ' + createData.message);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showResult('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        async function returnTool() {
            const firstName = document.getElementById('return_first_name').value.trim();
            const lastName = document.getElementById('return_last_name').value.trim();
            const employeeId = document.getElementById('return_employee_id').value.trim();
            const conditionAfter = document.getElementById('condition_after').value.trim();
            const notes = document.getElementById('return_notes').value.trim();
            const resultDiv = document.getElementById('result');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!firstName || !lastName) {
                showResult('error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ò–º—è –∏ –§–∞–º–∏–ª–∏—è');
                return;
            }
            
            showResult('info', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–æ–∑–≤—Ä–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                const verifyResponse = await fetch('/api/verify-return', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        employee_id: employeeId,
                        tool_id: currentToolId
                    })
                });
                
                const verifyData = await verifyResponse.json();
                
                if (!verifyData.success) {
                    showResult('error', verifyData.message);
                    return;
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                const returnResponse = await fetch('/api/return-tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_id: verifyData.request_id,
                        condition_after: conditionAfter,
                        notes: notes
                    })
                });
                
                const returnData = await returnResponse.json();
                
                if (returnData.success) {
                    showResult('success', 
                        '‚úÖ ' + returnData.message +
                        '<br>–í—Ä–µ–º—è –≤–æ–∑–≤—Ä–∞—Ç–∞: ' + returnData.timestamp);
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('returnToolForm').reset();
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Ñ–æ—Ä–º—É –≤–∑—è—Ç–∏—è
                    document.getElementById('returnForm').style.display = 'none';
                    document.getElementById('takeForm').style.display = 'block';
                    isToolAvailable = true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    updateToolStatus(true);
                    
                } else {
                    showResult('error', '‚ùå ' + returnData.message);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showResult('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updateToolStatus(isAvailable) {
            const statusElement = document.querySelector('.tool-status');
            if (isAvailable) {
                statusElement.textContent = '‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–∑—è—Ç–∏—è';
                statusElement.className = 'tool-status status-available';
            } else {
                statusElement.textContent = '‚ùå –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–¥–∞–Ω';
                statusElement.className = 'tool-status status-taken';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function showResult(type, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = '';
            resultDiv.classList.add('result-' + type);
            resultDiv.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        

        document.addEventListener('DOMContentLoaded', function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                {% if not tool.is_available and active_request and active_request.requester %}
                {% set user = active_request.requester %}
                document.getElementById('return_first_name').value = "{{ user.first_name }}";
                document.getElementById('return_last_name').value = "{{ user.last_name }}";
                {% if user.employee_id %}
                document.getElementById('return_employee_id').value = "{{ user.employee_id }}";
                {% endif %}
                {% endif %}
            });


    </script>
</body>
</html>